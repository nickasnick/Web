<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Fleet Management Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
 body { font-family: system-ui, sans-serif; }
</style>
</head>
<body class="bg-slate-100 p-4">

<h1 class="text-2xl font-bold mb-4">üöó Fleet Management Dashboard</h1>

<!-- FILTER -->
<div class="bg-white p-4 rounded shadow mb-4 flex flex-wrap gap-3">
  <select id="carFilter" class="border rounded px-3 py-2"></select>
  <button onclick="checkExpireAlerts()" class="bg-red-500 text-white px-4 py-2 rounded">
    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  </button>
</div>

<!-- CAR INFO -->
<div id="carInfo" class="bg-white p-4 rounded shadow mb-4"></div>

<!-- FUEL -->
<div class="bg-white p-4 rounded shadow mb-4">
  <h2 class="font-bold mb-2">‚õΩ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</h2>
  <div id="fuelSummary"></div>
</div>

<!-- INSURANCE -->
<div class="bg-white p-4 rounded shadow">
  <h2 class="font-bold mb-2">üõ°Ô∏è ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</h2>
  <div id="insuranceTable"></div>
</div>

<script>
// ================= CONFIG =================
const URL_CAR = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWS4RbhZlYQ1RnZCM41Pz3UPYXVb5lFId8T6S8vyQyuYzox44BylJQdnzlUdmRzE4f0u7sPy75SuqY/pub?gid=0&single=true&output=csv";
const URL_FUEL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWS4RbhZlYQ1RnZCM41Pz3UPYXVb5lFId8T6S8vyQyuYzox44BylJQdnzlUdmRzE4f0u7sPy75SuqY/pub?gid=1526088813&single=true&output=csv";
const URL_INS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWS4RbhZlYQ1RnZCM41Pz3UPYXVb5lFId8T6S8vyQyuYzox44BylJQdnzlUdmRzE4f0u7sPy75SuqY/pub?gid=63476950&single=true&output=csv";

// ================= DATA =================
let carData = [];
let fuelData = [];
let insData  = [];

// ================= CSV LOADER =================
function loadCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{
      download:true,
      header:true,
      skipEmptyLines:true,
      complete:r=>resolve(r.data),
      error:e=>reject(e)
    });
  });
}

// ================= LOAD ALL =================
function loadAll(){
  Promise.all([
    loadCSV(URL_CAR),
    loadCSV(URL_FUEL),
    loadCSV(URL_INS)
  ]).then(([cars,fuel,ins])=>{
    carData = cars;
    fuelData = fuel;
    insData  = ins;

    buildCarFilter();
    renderAll();
    checkExpireAlerts();
  });
}

// ================= UI =================
function buildCarFilter(){
  const sel = document.getElementById("carFilter");
  sel.innerHTML = `<option value="ALL">‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
  carData.forEach(c=>{
    sel.innerHTML += `<option value="${c.CarID}">${c.CarID}</option>`;
  });
  sel.onchange = renderAll;
}

function renderAll(){
  const carId = document.getElementById("carFilter").value;
  renderCarInfo(carId);
  renderFuel(carId);
  renderInsurance(carId);
}

// ================= CAR INFO =================
function renderCarInfo(carId){
  const box = document.getElementById("carInfo");
  if(carId==="ALL"){
    box.innerHTML = `<b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</b> ${carData.length} ‡∏Ñ‡∏±‡∏ô`;
    return;
  }

  const car = carData.find(c=>c.CarID===carId);
  if(!car) return;

  box.innerHTML = `
  <h2 class="font-bold mb-2">üöô ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ ${car.CarID}</h2>
  <div class="grid grid-cols-2 gap-2 text-sm">
    <div>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${car.Plate}</div>
    <div>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠: ${car.Brand}</div>
    <div>‡∏£‡∏∏‡πà‡∏ô: ${car.Model}</div>
    <div>‡∏õ‡∏µ: ${car.Year}</div>
    <div>‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏°‡∏î: ${car.TaxExpire}</div>
    <div>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î: ${car.InsuranceExpire}</div>
    <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${car.Location}</div>
  </div>
  `;
}

// ================= FUEL =================
function renderFuel(carId){
  const box = document.getElementById("fuelSummary");
  let data = fuelData;

  if(carId!=="ALL"){
    data = data.filter(f=>f.CarID===carId);
  }

  const sum = {};
  data.forEach(f=>{
    const c = f.CarID;
    const cost = Number(f.Price||0);
    if(!sum[c]) sum[c]=0;
    sum[c]+=cost;
  });

  let html = `<table class="w-full text-sm">
    <tr class="border-b font-bold">
      <td>Car</td><td class="text-right">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</td>
    </tr>`;

  Object.keys(sum).forEach(k=>{
    html+=`
      <tr>
        <td>${k}</td>
        <td class="text-right">‡∏ø${sum[k].toLocaleString()}</td>
      </tr>
    `;
  });

  html += "</table>";
  box.innerHTML = html;
}

// ================= INSURANCE =================
function renderInsurance(carId){
  const box = document.getElementById("insuranceTable");
  let data = insData;

  if(carId!=="ALL"){
    data = data.filter(i=>i.CarID===carId);
  }

  data = data.sort((a,b)=>Number(a.Premium)-Number(b.Premium));

  let html = `<table class="w-full text-sm">
    <tr class="border-b font-bold">
      <td>Car</td>
      <td>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</td>
      <td class="text-right">‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</td>
      <td>‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á</td>
      <td>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</td>
    </tr>`;

  data.forEach(i=>{
    html+=`
      <tr>
        <td>${i.CarID}</td>
        <td>${i.Company}</td>
        <td class="text-right">‡∏ø${Number(i.Premium).toLocaleString()}</td>
        <td>${i.Coverage}</td>
        <td>${i.EndDate}</td>
      </tr>
    `;
  });

  html+="</table>";
  box.innerHTML = html;
}

// ================= ALERT =================
function checkExpireAlerts(){
  const today = new Date();
  const alerts = [];

  carData.forEach(c=>{
    const tax = new Date(c.TaxExpire);
    const ins = new Date(c.InsuranceExpire);

    const taxDiff = (tax-today)/(1000*60*60*24);
    const insDiff = (ins-today)/(1000*60*60*24);

    if(taxDiff<=30){
      alerts.push(`üöó ${c.CarID} ‡∏†‡∏≤‡∏©‡∏µ‡∏à‡∏∞‡∏´‡∏°‡∏î‡πÉ‡∏ô ${Math.ceil(taxDiff)} ‡∏ß‡∏±‡∏ô`);
    }
    if(insDiff<=30){
      alerts.push(`üõ°Ô∏è ${c.CarID} ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏à‡∏∞‡∏´‡∏°‡∏î‡πÉ‡∏ô ${Math.ceil(insDiff)} ‡∏ß‡∏±‡∏ô`);
    }
  });

  if(alerts.length){
    Swal.fire({
      title:"‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô",
      html:alerts.join("<br>"),
      icon:"warning"
    });
  }
}

// ================= START =================
loadAll();

</script>
</body>
</html>